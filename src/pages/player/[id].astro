---
import Layout from "@/layouts/Layout.astro";
import Header from "@/components/Header.astro";
import PlayerHeroSection from "@/components/PlayerHeroSection.astro";
import StatsVisualization from "@/components/StatsVisualization.astro";
import InfoCard from "@/components/InfoCard.astro";
import MatchTimeline from "@/components/MatchTimeline.astro";
import HeadToHeadSearch from "@/components/HeadToHeadSearch.astro";
import { tennisApi } from "@/lib/api/tennisApi";
import type { CompetitorProfile } from "@/lib/api/types";

export const prerender = false;

interface PlayerData {
  id: string;
  name: string;
  nationality: string;
  countryCode: string;
  abbreviation?: string;
}



const { id } = Astro.params;

if (!id) {
  return Astro.redirect("/rankings");
}

let profile: CompetitorProfile | null = null;
let error: string | null = null;

try {
  profile = await tennisApi.getCompetitorProfile(id);
} catch (e) {
  error = e instanceof Error ? e.message : "Failed to load player profile";
  console.error("Player profile error:", e);
}

let player: PlayerData | null = null;
let tourType: 'ATP' | 'WTA' = 'ATP';
let currentRank: number | undefined;

if (profile) {
  player = {
    id: profile.id,
    name: profile.name,
    nationality: profile.country,
    countryCode: profile.country_code,
    abbreviation: profile.abbreviation
  };

  tourType = profile.gender === 'female' ? 'WTA' : 'ATP';
  currentRank = profile.competitor_rankings.find(r => r.type === 'singles')?.rank;
}
---

<Layout title={profile ? `${profile.name} - Player Profile` : "Player Profile"} description={profile ? `Detailed profile for tennis player ${profile.name}` : "Player profile information"}>
  <Header />

  {error ? (
    <!-- Error State -->
    <div class="min-h-screen flex items-center justify-center px-4">
      <div class="bg-red-50 dark:bg-red-950/20 border border-red-200 dark:border-red-800 rounded-lg p-6 text-center max-w-md mx-auto">
        <div class="text-2xl mb-2">⚠️</div>
        <h3 class="text-lg font-semibold text-red-800 dark:text-red-200 mb-2">Error Loading Profile</h3>
        <p class="text-red-600 dark:text-red-300 mb-4 text-sm">{error}</p>
        <a href="/rankings" class="btn-outline text-sm">← Back to Rankings</a>
      </div>
    </div>
  ) : profile ? (
    <!-- Main Content -->
    <div>
      <!-- Hero Section -->
      <PlayerHeroSection
        profile={profile}
        player={player!}
        tourType={tourType}
        currentRank={currentRank}
      />

      <!-- Content Grid -->
      <div class="max-w-6xl mx-auto px-4 py-6 space-y-6">

        <!-- Stats and Matches Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <!-- Stats -->
          <StatsVisualization profile={profile} tourType={tourType} />

          <!-- Recent Matches -->
          <MatchTimeline playerId={profile.id} playerName={profile.name} />
        </div>

        <!-- Head-to-Head Search -->
        <div class="bg-white dark:bg-surface-900 rounded-lg border border-surface-200 dark:border-surface-700 p-4">
          <HeadToHeadSearch playerId={profile.id} playerName={profile.name} />
        </div>

      </div>
    </div>
  ) : (
    <!-- Loading State -->
    <div class="min-h-screen flex items-center justify-center">
      <div class="text-center bg-white dark:bg-surface-900 rounded-lg border border-surface-200 dark:border-surface-700 p-8">
        <div class="mb-4 inline-block h-8 w-8 animate-spin rounded-full border-4 border-tennis-400/30 dark:border-tennis-500/30 border-t-tennis-600 dark:border-t-tennis-400"></div>
        <p class="text-surface-600 dark:text-surface-300 mb-1">Loading player profile...</p>
        <p class="text-sm text-surface-500 dark:text-surface-400">Please wait while we fetch the latest data</p>
      </div>
    </div>
  )}
</Layout>